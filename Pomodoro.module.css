from utils.configuration.configuration import Configurations
from utils.feed.feed import Feed
from re import sub
from typing import List, Dict


class HierarchyLevelFeed(Feed):
    def __init__(self):
        Feed.__init__(self)
        config = Configurations()
        self._sds_hierarchy_feed_attributes_config = config.get_sds_hierarchylevel_attributes()

    def _hierarchy_feed_content(self, hierarchy_data: List[Dict[str, any]], feed_name: str):
        if "attributes" not in self._sds_hierarchy_feed_attributes_config:
            raise Exception("Did not find attributes to create Hierarchy feed.")

        headers = self._sds_hierarchy_feed_attributes_config["attributes"]
        headers = sub(r"[\n\t\s]*", "", headers).split(",")

        # Prepare columns for Level10, Level09, ..., and so on
        hierarchy_feed_outputs = []
        for hierarchy in hierarchy_data:
            curr_hierarchy_info = {}
            
            for level in range(10, 0, -1):  # Iterating from Level10 to Level01
                level_id_key = f"Level{level}Id"
                level_name_key = f"Level{level}Name"
                
                curr_hierarchy_info[level_id_key] = hierarchy.get("id") if hierarchy.get("type") == f"Level{level}" else None
                curr_hierarchy_info[level_name_key] = hierarchy.get("name") if hierarchy.get("type") == f"Level{level}" else None

            # Append to outputs
            hierarchy_feed_outputs.append(curr_hierarchy_info)

        # Include headers for all levels
        level_headers = [f"Level{level}Id,Level{level}Name" for level in range(10, 0, -1)]
        all_headers = ",".join(level_headers)

        return self._create_feed_file(all_headers.split(","), hierarchy_feed_outputs, feed_name)

    def feed(self, hierarchy_data):
        feed_name = self._feed_name(sds_entity="hierarchylevel_feed", is_json=False)
        feed_file_content = self._hierarchy_feed_content(hierarchy_data, feed_name)
        self._save(feed_name, content=feed_file_content)
        return feed_name