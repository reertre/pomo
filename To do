#!/bin/bash
set -e

# Load configuration variables from config.cfg.
CONFIG_FILE="config.cfg"
if [ ! -f "$CONFIG_FILE" ]; then
  echo "Error: $CONFIG_FILE not found!"
  exit 1
fi
source "$CONFIG_FILE"

# Ensure the required variables are set.
if [ -z "$CHG" ] || [ -z "$RELEASE_VERSION" ]; then
    echo "Error: Both CHG and RELEASE_VERSION must be defined in config.cfg."
    exit 1
fi

# Define the original (old) values that are in the existing folder structure.
OLD_CHG="CHG99999999999"
OLD_REL="99.9"

echo "Renaming items containing '$OLD_CHG' to use '$CHG'..."
# Use find with -depth (to rename inner files/directories before their parent directories)
find . -depth -name "*${OLD_CHG}*" -print0 | while IFS= read -r -d '' item; do
    # Use sed to substitute OLD_CHG with the new CHG value.
    new_item=$(echo "$item" | sed "s/${OLD_CHG}/${CHG}/g")
    if [ "$item" != "$new_item" ]; then
        echo "Renaming: $item -> $new_item"
        mv "$item" "$new_item"
    fi
done

echo "Renaming items containing '$OLD_REL' to use '$RELEASE_VERSION'..."
find . -depth -name "*${OLD_REL}*" -print0 | while IFS= read -r -d '' item; do
    # Replace all occurrences of OLD_REL with the new RELEASE_VERSION.
    new_item=$(echo "$item" | sed "s/${OLD_REL}/${RELEASE_VERSION}/g")
    if [ "$item" != "$new_item" ]; then
        echo "Renaming: $item -> $new_item"
        mv "$item" "$new_item"
    fi
done

echo "Renaming complete."